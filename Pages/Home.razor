@page "/"
@using EventEaseApp.Models
@using EventEaseApp.Components
@using EventEaseApp.Services
@inject EventService EventService
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject HttpClient Http
@inject NavigationManager Navigation

<h3>Events List</h3>
<style>
    .list-group-item {
        transition: transform 0.2s ease;
    }
    .list-group-item:hover {
        transform: scale(1.05);
        z-index: 1;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
</style>
<div style="width:50vw; margin:0 auto; text-align:center;">
    <button class="btn btn-outline-secondary btn-sm me-2" @onclick="PrevPage" disabled="@(currentPage == 1)">Prev</button>
    <span>Page @currentPage of @totalPages</span>
    <button class="btn btn-outline-secondary btn-sm ms-2" @onclick="NextPage" disabled="@(currentPage == totalPages)">Next</button>
</div>
<ul class="list-group" style="width:50vw; margin:0 auto;">
    @foreach (var evt in pagedEvents)
    {
        <li class="list-group-item" @onclick="() => NavigateToRegister(evt.Id)" style="cursor:pointer;">
            <img src="@evt.ImageUrl" alt="@evt.Name thumbnail" width="60" height="40" style="object-fit:cover; margin-right:10px; vertical-align:middle;" />
            <strong>@evt.Name (@evt.Date.ToString("MMM dd, yyyy"))</strong><br />
            <span>@evt.Location</span><br />
            <span>@evt.Description</span>
        </li>
    }
</ul>

@code {
    private int currentPage = 1;
    private int pageSize = 5;
    private int totalPages => (int)Math.Ceiling((double)EventService.Events.Count / pageSize);
    private List<Event> pagedEvents => EventService.Events.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();

    private void PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
        }
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
        }
    }

    private void NavigateToRegister(int eventId)
    {
        Navigation.NavigateTo($"/register?eventId={eventId}");
    }

    protected override async Task OnInitializedAsync()
    {
        var loaded = await LocalStorage.GetItemAsync<List<Event>>("events");
        if (loaded == null || loaded.Count == 0)
        {
            var response = await Http.GetAsync("data/events.json");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var events = System.Text.Json.JsonSerializer.Deserialize<List<Event>>(json);
                if (events != null)
                {
                    await LocalStorage.SetItemAsync("events", events);
                    await EventService.LoadEventsAsync();
                }
            }
        }
        else
        {
            await EventService.LoadEventsAsync();
        }
    }

}
